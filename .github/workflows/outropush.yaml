name: ci-pr

on:
  push:
    
jobs:
  check-origin-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set origin branch
        id: set_branch
        run: echo "origin_branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_ENV

      - name: Check origin branch name
        id: check_branch
        run: |
          if [[ ! "${{ env.origin_branch }}" =~ ^(PRJ-|HOTFIX-|release/).* ]]; then
            echo "Error: Origin branch name must start with PRJ-, HOTFIX-, or release/."
            exit 1
          fi

  code_quality:
    runs-on: ubuntu-latest
    needs: check-origin-branch
    if: always() && needs.check-origin-branch.result == 'success'
    steps:
      - uses: actions/checkout@v2
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - name: Check bash
        run: | 
          echo $0  
          which bash   
      - name: Flutter version
        run: flutter --version                     
      - name: Run Lint
        run: flutter analyze --no-pub | grep -v 'TODO:'
      - name: Run tests with coverage
        run: flutter test --coverage
      - name: Verify test coverage
        run: |
          flutter pub global activate very_good_cli 
          very_good test -j 1 --optimization --coverage
      - name: ðŸ“Š Check Code Coverage
        uses: VeryGoodOpenSource/very_good_coverage@v2
        with:
          min_coverage: 80    
